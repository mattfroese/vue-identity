/**
  * vue-identity v0.0.4
  * (c) 2017 Matt Froese
  * @license MIT
  */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.VueIdentity=t()}(this,function(){"use strict";function e(e){var t={code:-1,http:null};return void 0!==e.status?(t.code=e.status,t.error=e.statusText,t.data=e.data?e.data.errors:null,t.http=e,t.message=r(t)):"string"==typeof e?t.message=t.error=e:t.message=e.error=e.message,console.error("[VueIdentity Error]",t),Promise.reject(t)}function t(e){var t=e.split(".")[1],r=t.replace("-","+").replace("_","/");return JSON.parse(window.atob(r))}function r(e){return"Connection Issue"==e.error?"Could not connect":"Bad Request"==e.error?"Invalid data":"Token Expired"==e.error?"Token Expired":500==e.code?"Server Error":404==e.code?"Not Found":403==e.code?"Forbidden":401==e.code?"Unauthorized":"Unknown error"}var n={defaults:{url:"/api",loginUrl:"/login",logoutUrl:"/logout",refreshUrl:"/refresh",accessToken:"token",refreshToken:"refresh",unauthorizedRedirect:null,redirect:null,scope:null},install:function(r,o){if(!n.installed){var i=new r({data:{refreshToken:window.localStorage["vue-identity:refreshToken"],accessToken:null,expires:null,user:null,notBefore:null,issuedAt:null,loading:!1,checking:!1,expiryTimer:null},computed:{expiresIn:function(){return!!this.expires&&1e3*this.expires-Date.now()}}}),u=r.prototype.$identity=i,s=Object.assign(n.defaults,o),a=r.http,c=o.router;a||console.error("VueIdentity requires vue-resource. Make sure you Vue.use(VueResource) before Vue.use(VueIdentity)"),r.http.interceptors.push(function(e,t){u.accessToken&&e.headers.set("Authorization","Bearer "+u.accessToken),t()}),c?c.beforeEach(function(e,t,r){var n=s.router.app.$identity;e.meta.identity&&null===n.user?n.authenticate().then(function(){r()},function(){s.unauthorizedRedirect&&r({path:s.unauthorizedRedirect})}):r()}):console.info("To use with vue-router, pass it to me Vue.use(VueIdentity, {router})"),window.onfocus=function(){u.attemptRefresh()},u.uri=function(e){return s.url+s[e+"Url"]},u.authenticate=function(){return u.isLoggedIn()?Promise.resolve():u.refreshToken?u.refresh().catch(function(){return u.authenticate()}):u.loginWithCredentials()},u.refresh=function(){return u.attachRequestQuarterback(a.post(u.uri("refresh"),{token:u.refreshToken}))},u.login=function(e){return u.attachRequestQuarterback(a.post(u.uri("login"),e,{credentials:!0,params:params}))},u.loginWithCredentials=function(){var e={};return s.scope&&(e.scope=s.scope),s.redirect&&(e.redirect=s.redirect),u.attachRequestQuarterback(a.get(u.uri("login"),{credentials:!0,params:e}))},u.logout=function(){return delete localStorage["vue-identity:refreshToken"],u.refreshToken=null,u.accessToken=null,u.user=null,u.expires=null,u.issuedAt=null,u.notBefore=null,Promise.resolve()},u.attachRequestQuarterback=function(t){return u.loading=!0,t.then(function(e){return u.receivethMightyToken(e.data),Promise.resolve()}).catch(function(t){return u.logout(),t.headers.get("X-Authentication-Location")&&(window.location.href=t.headers.get("X-Authentication-Location")),e(t)}).finally(function(){u.loading=!1})},u.receivethMightyToken=function(r){var n=r[s.accessToken],o=r[s.refreshToken];if(void 0==n)return e("No token received");var i=t(n);u.accessToken=n,u.refreshToken=localStorage["vue-identity:refreshToken"]=o,u.user=i,u.expires=i.exp,u.issuedAt=i.iat,u.notBefore=i.nbf,u.attemptRefreshIn(u.expiresIn-3e4)},u.attemptRefreshIn=function(e){console.info("attemptRefreshIn",e),clearTimeout(u.expiryTimer),u.expiryTimer=setTimeout(function(){u.attemptRefresh()},e)},u.attemptRefresh=function(){var e=1e3*u.expires-Date.now();console.info("attemptRefresh",e),u.tokenValid()&&e<=3e5&&(console.info("attemptRefresh tokenValid expiresIn <= 300000",e),u.refresh().catch(function(){clearInterval(u.expiryTimer)}))},u.isLoggedIn=function(){return u.tokenValid()},u.tokenValid=function(){return u.refreshToken&&1e3*u.expires-Date.now()>0}}}};return n});