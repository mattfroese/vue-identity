/**
  * vue-identity v0.0.6
  * (c) 2017 Matt Froese
  * @license MIT
  */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):e.VueIdentity=r()}(this,function(){"use strict";function e(e){var r={code:-1,http:null};return void 0!==e.status?(r.code=e.status,r.error=e.statusText,r.data=e.data?e.data.errors:null,r.http=e,r.message=t(r)):"string"==typeof e?r.message=r.error=e:r.message=e.error=e.message,console.error("[VueIdentity Error]",r),r}function r(e){var r=e.split(".")[1],t=r.replace("-","+").replace("_","/");return JSON.parse(window.atob(t))}function t(e){return"Connection Issue"==e.error?"Could not connect":"Bad Request"==e.error?"Invalid data":"Token Expired"==e.error?"Token Expired":500==e.code?"Server Error":404==e.code?"Not Found":403==e.code?"Forbidden":401==e.code?"Unauthorized":"Unknown error"}var n={defaults:{url:"/api",loginUrl:"/login",refreshUrl:"/refresh",accessToken:"token",refreshToken:"refresh",autoRefresh:!0,unauthorizedRedirect:null,redirect:null,scope:null},install:function(t,o){if(!n.installed){var i=new t({data:{refreshToken:window.localStorage["vue-identity:refresh-token"],accessToken:null,expires:null,user:null,notBefore:null,issuedAt:null,loading:!1},computed:{expiresIn:function(){return!!this.expires&&1e3*this.expires-Date.now()}}}),u=t.prototype.$identity=i,s=Object.assign(n.defaults,o),a=t.http,c=o.router;a||console.error("VueIdentity requires vue-resource. Make sure you Vue.use(VueResource) before Vue.use(VueIdentity)"),t.http.interceptors.push(function(e,r){if(e.url===u.uri("login")||e.url===u.uri("refresh"))return r();u.authenticate({preventRedirect:!0}).then(function(){e.headers.set("Authorization","Bearer "+u.accessToken),r()})}),c?c.beforeEach(function(e,r,t){e.meta.identity&&u.isLoggedIn()===!1?u.authenticate().then(function(){t()},function(){s.unauthorizedRedirect&&t({path:s.unauthorizedRedirect})}):t()}):console.info("To use with vue-router, pass it to me Vue.use(VueIdentity, {router})"),u.uri=function(e){return s.url+s[e+"Url"]},u.authenticate=function(e){if(u.isLoggedIn())return Promise.resolve();if(u.refreshToken)return u.refresh().catch(function(){return u.authenticate()});var r={};return e&&e.scope&&(r.scope=e.scope),e&&e.redirect&&(r.redirect=e.redirect),u.request(a.get(u.uri("login"),{credentials:!0,params:r}),o)},u.refresh=function(){return u.request(a.post(u.uri("refresh"),{token:u.refreshToken}))},u.login=function(e){var r={};return s&&s.scope&&(r.scope=s.scope),s&&s.redirect&&(r.redirect=s.redirect),u.request(a.post(u.uri("login"),e,{credentials:!0,params:r}))},u.logout=function(){return delete localStorage["vue-identity:refresh-token"],u.refreshToken=null,u.accessToken=null,u.user=null,u.expires=null,u.issuedAt=null,u.notBefore=null,Promise.resolve()},u.request=function(r,t){return t=t||{},u.loading=!0,r.then(function(e){return u.receive(e.data)}).catch(function(r){return u.logout(),r.headers&&r.headers.get("X-Authentication-Location")&&!t.preventRedirect&&(window.location.href=r.headers.get("X-Authentication-Location")),Promise.reject(e(r))}).finally(function(){u.loading=!1})},u.receive=function(t){var n=t[s.accessToken],o=t[s.refreshToken];if(void 0==n)return Promise.reject(e("No token received"));var i=r(n);return u.accessToken=n,u.refreshToken=localStorage["vue-identity:refresh-token"]=o,u.user=i,u.expires=i.exp,u.issuedAt=i.iat,u.notBefore=i.nbf,u.refreshToken&&s.autoRefresh&&u.autoRefresh(),Promise.resolve()},u.autoRefresh=function(){if(!u.refreshToken)return!1;var e=1e3*u.expires-Date.now();console.info("autoRefresh enabled, will refresh in",e),setTimeout(u.refresh,e)},u.isLoggedIn=function(){return u.tokenValid()},u.tokenValid=function(){return!!u.accessToken&&1e3*u.expires-Date.now()>0}}}};return n});